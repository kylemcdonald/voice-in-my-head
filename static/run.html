<html>

<head>
  <title>Voice In My Head</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
  <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@1,500&display=swap" rel="stylesheet">
  <script>
    // Configuration
    const ICE_SERVERS = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
    ];

    // State
    let pc = null;
    let ws = null;
    let localStream = null;
    let started = false;

    // Warn before leaving the page
    window.addEventListener('beforeunload', (event) => {
      event.preventDefault();
      event.returnValue = 'Are you sure you want to exit?';
      return 'Are you sure you want to exit?';
    });

    window.addEventListener('DOMContentLoaded', async () => {
      // Show debug button on dev server
      if (window.location.hostname.includes('dev')) {
        const debugButton = document.getElementById('debug-button');
        debugButton.classList.remove('hidden');
      }

      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');

      if (!sessionId) {
        showError('Missing session_id');
        return;
      }

      try {
        await initWebRTC(sessionId);
      } catch (err) {
        console.error('Failed to initialize:', err);
        showError(err.message);
      }
    });

    function showError(message) {
      const button = document.getElementById('start-button');
      button.innerText = 'Error';
      button.classList.add('bg-red-500');
      console.error(message);
    }

    async function initWebRTC(sessionId) {
      // Request microphone permission first
      console.log('Requesting microphone...');
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
          }
        });
        console.log('Got microphone access');
      } catch (err) {
        console.error('Microphone access denied:', err);
        showError('Microphone access required');
        return;
      }

      // Create WebSocket connection for signaling
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${wsProtocol}//${window.location.host}/ws/${sessionId}`;
      console.log('Connecting to WebSocket:', wsUrl);

      ws = new WebSocket(wsUrl);
      window.ws = ws; // For debugging

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        showError('Connection failed');
      };

      ws.onclose = () => {
        console.log('WebSocket closed');
      };

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        console.log('Received:', msg.type);

        switch (msg.type) {
          case 'offer':
            await handleOffer(msg.sdp);
            break;
          case 'ice-candidate':
            await handleIceCandidate(msg);
            break;
          case 'app-message':
            handleAppMessage(msg.data);
            break;
          default:
            console.log('Unknown message type:', msg.type);
        }
      };
    }

    async function handleOffer(sdp) {
      console.log('Handling SDP offer');

      // Create peer connection
      pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
      window.pc = pc; // For debugging

      // Add local tracks
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
        console.log('Added local track:', track.kind);
      });

      // Handle remote tracks (audio from server)
      pc.ontrack = (event) => {
        console.log('Got remote track:', event.track.kind);
        if (event.track.kind === 'audio') {
          // Create audio element to play remote audio
          const audio = document.createElement('audio');
          audio.srcObject = event.streams[0];
          audio.autoplay = true;
          document.body.appendChild(audio);
          console.log('Audio playback started');
        }
      };

      // Handle ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          console.log('Sending ICE candidate');
          ws.send(JSON.stringify({
            type: 'ice-candidate',
            candidate: event.candidate.candidate,
            sdpMid: event.candidate.sdpMid,
            sdpMLineIndex: event.candidate.sdpMLineIndex,
          }));
        }
      };

      // Handle connection state changes
      pc.onconnectionstatechange = () => {
        console.log('Connection state:', pc.connectionState);
        if (pc.connectionState === 'connected') {
          onConnected();
        } else if (pc.connectionState === 'failed') {
          showError('Connection failed');
        }
      };

      // Set remote description and create answer
      await pc.setRemoteDescription({ type: 'offer', sdp: sdp });
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // Send answer
      ws.send(JSON.stringify({
        type: 'answer',
        sdp: answer.sdp,
      }));
      console.log('Sent SDP answer');
    }

    async function handleIceCandidate(msg) {
      if (!pc) return;

      try {
        await pc.addIceCandidate({
          candidate: msg.candidate,
          sdpMid: msg.sdpMid,
          sdpMLineIndex: msg.sdpMLineIndex,
        });
        console.log('Added ICE candidate');
      } catch (err) {
        console.warn('Failed to add ICE candidate:', err);
      }
    }

    function handleAppMessage(data) {
      if (data.event === 'chat-msg') {
        addMessage(data.user, data.message);
      }
    }

    function onConnected() {
      console.log('WebRTC connected!');

      // Enable start button immediately
      const button = document.getElementById('start-button');
      button.innerText = 'Tap to Start';
      button.classList.remove('bg-gray-500');
      button.classList.add('bg-blue-500', 'hover:bg-blue-700');
      button.disabled = false;
    }

    function start() {
      // Send start message
      ws.send(JSON.stringify({
        type: 'app-message',
        data: { message: 'start' }
      }));

      const button = document.getElementById('start-button');
      button.classList.add('hidden');
      started = true;
    }

    function toggleDebug() {
      const debug = document.getElementById('debug-panel');
      debug.classList.toggle('hidden');
    }

    function addMessage(user, text) {
      const transcript = document.getElementById('transcript');
      const div = document.createElement('div');
      div.classList.add('p-3', 'm-1', 'rounded-lg', 'text-white');
      if (!started) {
        div.classList.add('opacity-25');
      }
      if (user === 'user') {
        div.classList.add('self-end', 'bg-blue-800', 'ml-10');
      } else {
        div.classList.add('self-start', 'bg-gray-800', 'mr-10');
      }
      div.innerText = text;
      transcript.appendChild(div);

      // Auto-scroll to bottom
      transcript.scrollTop = transcript.scrollHeight;
    }
  </script>
</head>

<body class="bg-black" style="overflow: hidden;">

  <div id="transcript"
    class="flex flex-col justify-end items-center fixed bottom-0 left-0 w-full h-full p-2 overflow-y-scroll">
  </div>

  <div id="debug-panel" class="hidden fixed top-16 left-0 w-full p-3 bg-gray-900 text-white font-mono text-sm">
    <p>WebRTC Connection</p>
    <p id="debug-state">State: initializing</p>
  </div>

  <div id="controls" class="flex justify-between items-center fixed top-0 left-0 w-full p-3">
    <button id="start-button"
      class="bg-gray-500 text-white font-bold py-2 px-4 rounded font-mono italic rounded-xl text-5xl" disabled
      onclick="start()">
      Loading...
    </button>
    <button id="debug-button"
      class="hidden bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl text-5xl font-mono italic"
      onclick="toggleDebug()">
      Toggle Debug
    </button>
  </div>

</body>

</html>
